<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ ranking_title }} | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css?v=1003">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ===== Ranking Tabs ===== -->
  <div class="ranking-tabs">
    <a href="/ranking?period=day"   class="ranking-tab {% if period=='day' %}active{% endif %}">æ—¥</a>
    <a href="/ranking?period=week"  class="ranking-tab {% if period=='week' %}active{% endif %}">é€±</a>
    <a href="/ranking?period=month" class="ranking-tab {% if period=='month' %}active{% endif %}">æœˆ</a>
  </div>

  <h2 class="ranking-heading">{{ ranking_title }}</h2>

  {% if posts %}
    {% for post in posts %}
    <article class="post ranking-post rank-{{ loop.index }}">

      <!-- âœ… å…¨ä½“é·ç§»ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <a href="/post/{{ post.id }}" class="post-overlay" aria-label="æŠ•ç¨¿è©³ç´°"></a>

      <!-- ===== Header ===== -->
      <div class="post-top">

        <div class="post-title">

          <span class="rank-badge rank-{{ loop.index }}">{{ loop.index }}</span>

          {% if post.user_icon %}
            <div class="avatar">
              <a href="/user/{{ post.profile_key | urlencode }}" onclick="event.stopPropagation();">
                <img src="{{ post.user_icon }}" alt="icon">
              </a>
            </div>
          {% else %}
            <a href="/user/{{ post.profile_key | urlencode }}" onclick="event.stopPropagation();">
              <span class="avatar-fallback"></span>
            </a>
          {% endif %}

          <a href="/user/{{ post.profile_key | urlencode }}" class="post-user" onclick="event.stopPropagation();">
            {{ post.display_name }}ï¼š{{ post.car }}
          </a>

        </div>

        <span class="post-date">{{ post.created_at }}</span>
      </div>

      {% if post.comment %}
        <div class="post-text">{{ post.comment }}</div>
      {% endif %}

      {% if post.image %}
        <div class="post-image">
          <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ">
        </div>
      {% endif %}

      <!-- âœ… Actionsã¯ overlay ã‚ˆã‚Šä¸Šã«ï¼†ã‚¯ãƒªãƒƒã‚¯å®Œå…¨é®æ–­ -->
      <div class="post-actions" onclick="event.stopPropagation();">

        <a href="/post/{{ post.id }}#comments" class="action-btn" onclick="event.stopPropagation();">
          ğŸ’¬ <span class="count">{{ post.comment_count }}</span>
        </a>

        {% if user %}
          <button type="button"
                  class="like-btn js-like {% if post.id in liked_posts %}liked{% endif %}"
                  data-post-id="{{ post.id }}"
                  onclick="event.stopPropagation();">
            <span class="heart">
              {% if post.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </span>
            <span class="like-count">{{ post.likes }}</span>
          </button>
        {% else %}
          <span>ğŸ¤ {{ post.likes }}</span>
        {% endif %}

      </div>

    </article>
    {% endfor %}
  {% else %}
    <p style="color:#888; margin-top:24px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}

</main>

<!-- ===== Like JSï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ»ç¢ºå®šç‰ˆï¼‰ ===== -->
<script>
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".js-like");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();
  if (e.stopImmediatePropagation) e.stopImmediatePropagation();

  const postId = btn.dataset.postId;
  if (!postId) return;

  if (btn.classList.contains("is-loading")) return;
  btn.classList.add("is-loading");

  try{
    const res = await fetch(`/api/like/${postId}`, {
      method: "POST",
      credentials: "same-origin"
    });

    if (!res.ok) {
      if (res.status === 401) location.href = "/login";
      return;
    }

    const data = await res.json();

    btn.classList.toggle("liked", data.liked);
    const heart = btn.querySelector(".heart");
    const count = btn.querySelector(".like-count");
    if (heart) heart.textContent = data.liked ? "â¤ï¸" : "ğŸ¤";
    if (count) count.textContent = data.likes;

  } finally {
    btn.classList.remove("is-loading");
  }
}, { passive:false });
</script>

</body>
</html>
