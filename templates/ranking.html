<!-- templates/ranking.htmlï¼ˆæ”¹è‰¯ç‰ˆãƒ•ãƒ«ï¼šè¤‡æ•°ç”»åƒå¯¾å¿œ + OGP + ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« + ã‚¯ãƒªãƒƒã‚¯é·ç§»å®‰å®š + likeçµ±ä¸€ï¼‰ -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ ranking_title }} | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ===== OGPï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯websiteæ‰±ã„ï¼‰ ===== -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Carbum">
  <meta property="og:title" content="{{ ranking_title }} | Carbum">
  <meta property="og:description" content="Carbumã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:image" content="https://car-album-3.onrender.com/static/ogp.png">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="stylesheet" href="/static/style.css?v=FINAL">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ===== Ranking Tabs ===== -->
  <div class="ranking-tabs">
    <a href="/ranking?period=day"   class="ranking-tab {% if period=='day' %}active{% endif %}">æ—¥</a>
    <a href="/ranking?period=week"  class="ranking-tab {% if period=='week' %}active{% endif %}">é€±</a>
    <a href="/ranking?period=month" class="ranking-tab {% if period=='month' %}active{% endif %}">æœˆ</a>
  </div>

  <h2 class="ranking-heading">{{ ranking_title }}</h2>

  {% if posts %}
    {% for post in posts %}
    <article class="post ranking-post rank-{{ loop.index }}"
             data-href="/post/{{ post.id }}">

      <!-- ===== Header ===== -->
      <div class="post-top">

        <div class="post-title">

          <!-- Rank -->
          <span class="rank-badge rank-{{ loop.index }}">{{ loop.index }}</span>

          <!-- Avatar -->
          {% if post.user_icon %}
            <a href="/user/{{ post.profile_key | urlencode }}" class="avatar">
              <img src="{{ post.user_icon }}" alt="icon">
            </a>
          {% else %}
            <a href="/user/{{ post.profile_key | urlencode }}">
              <span class="avatar-fallback"></span>
            </a>
          {% endif %}

          <!-- Name : Car -->
          <span class="post-user">
            {{ post.display_name }}ï¼š{{ post.car }}
          </span>

        </div>

        <span class="post-date">{{ post.created_at }}</span>
      </div>

      {% if post.comment %}
        <div class="post-text">{{ post.comment }}</div>
      {% endif %}

      <!-- ======================
           Imagesï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
           - post.images ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
           - ç„¡ã„å ´åˆã¯äº’æ›ã§ post.image
      ====================== -->
      {% if post.images and post.images|length > 0 %}

        {% if post.images|length == 1 %}
          <div class="post-image">
            <img src="{{ post.images[0] }}" alt="æŠ•ç¨¿ç”»åƒ" class="js-zoomable">
          </div>
        {% else %}
          <div class="post-images">
            <div class="post-images-track">
              {% for url in post.images %}
                <div class="post-image">
                  <img src="{{ url }}" alt="æŠ•ç¨¿ç”»åƒ" class="js-zoomable">
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

      {% elif post.image %}
        <div class="post-image">
          <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ" class="js-zoomable">
        </div>
      {% endif %}

      <!-- ===== Actions ===== -->
      <div class="post-actions">

        <!-- Comment -->
        <a href="/post/{{ post.id }}#comments" class="action-btn">
          ğŸ’¬ <span class="count">{{ post.comment_count }}</span>
        </a>

        <!-- Like -->
        {% if user %}
          {% set is_liked = (post.id in liked_posts) %}
          <button type="button"
                  class="like-btn js-like {% if is_liked %}active liked{% endif %}"
                  data-post-id="{{ post.id }}"
                  data-liked="{% if is_liked %}1{% else %}0{% endif %}">
            <span class="heart">{% if is_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
            <span class="like-count">{{ post.likes }}</span>
          </button>
        {% else %}
          <span>ğŸ¤ {{ post.likes }}</span>
        {% endif %}

      </div>

    </article>
    {% endfor %}
  {% else %}
    <p style="color:#888; margin-top:24px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}

</main>

<!-- ======================
     Image Modalï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ï¼‰
====================== -->
<div class="img-modal" id="imgModal">
  <div class="img-modal-inner">
    <img id="imgModalImg" src="" alt="zoomed">
  </div>
</div>

<!-- ===== JSï¼ˆå®Œå…¨å®‰å®šï¼‰ ===== -->
<script>
/* ========= ç”»åƒæ‹¡å¤§ ========= */
document.addEventListener("click", (e) => {
  const img = e.target.closest(".js-zoomable");
  if (img) {
    e.preventDefault();
    e.stopPropagation();
    const modal = document.getElementById("imgModal");
    const modalImg = document.getElementById("imgModalImg");
    modalImg.src = img.src;
    modal.classList.add("open");
    return;
  }
  const modal = e.target.closest("#imgModal");
  if (modal) {
    modal.classList.remove("open");
    const modalImg = document.getElementById("imgModalImg");
    modalImg.src = "";
    return;
  }
});

/* ========= æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰é·ç§» ========= */
document.querySelectorAll(".ranking-post").forEach(card => {
  card.addEventListener("click", (e) => {
    if (e.target.closest("a, button")) return;
    location.href = card.dataset.href;
  });
});

/* ========= ã„ã„ã­ï¼ˆå³æ™‚UI + ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ========= */
document.querySelectorAll(".js-like").forEach(btn => {
  btn.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (btn.disabled) return;
    btn.disabled = true;

    const postId = btn.dataset.postId;
    const likedBefore = btn.dataset.liked === "1";
    const countEl = btn.querySelector(".like-count");
    const heartEl = btn.querySelector(".heart");

    /* æ¥½è¦³çš„UI */
    btn.dataset.liked = likedBefore ? "0" : "1";
    btn.classList.toggle("liked", !likedBefore);
    btn.classList.toggle("active", !likedBefore);
    heartEl.textContent = likedBefore ? "ğŸ¤" : "â¤ï¸";
    countEl.textContent = Number(countEl.textContent) + (likedBefore ? -1 : 1);

    try {
      const res = await fetch(`/api/like/${postId}`, {
        method: "POST",
        credentials: "same-origin"
      });

      if (!res.ok) {
        if (res.status === 401) location.href = "/login";
        throw new Error();
      }

      const data = await res.json();

      btn.dataset.liked = data.liked ? "1" : "0";
      btn.classList.toggle("liked", data.liked);
      btn.classList.toggle("active", data.liked);
      heartEl.textContent = data.liked ? "â¤ï¸" : "ğŸ¤";
      countEl.textContent = data.likes;

    } catch {
      /* ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
      btn.dataset.liked = likedBefore ? "1" : "0";
      btn.classList.toggle("liked", likedBefore);
      btn.classList.toggle("active", likedBefore);
      heartEl.textContent = likedBefore ? "â¤ï¸" : "ğŸ¤";
      countEl.textContent = Number(countEl.textContent) + (likedBefore ? 1 : -1);
      alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      btn.disabled = false;
    }
  });
});
</script>

</body>
</html>