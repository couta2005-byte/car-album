def fetch_posts(db, me_user_id: Optional[str], where_sql="", params=(), order_sql="ORDER BY p.id DESC", limit_sql=""):
    cur = db.cursor()
    try:
        cur.execute(f"""
            SELECT
                p.id,
                COALESCE(u.username, p.username) AS username,

                -- ✅ 表示名 / handle を追加
                COALESCE(u.display_name, COALESCE(u.username, p.username)) AS display_name,
                u.handle AS handle,

                p.maker, p.region, p.car,
                p.comment, p.image, p.created_at,
                COUNT(l.post_id) AS like_count,
                pr.icon AS user_icon
            FROM posts p
            LEFT JOIN users u
                ON (p.user_id IS NOT NULL AND p.user_id = u.id)
                OR (p.user_id IS NULL AND p.username = u.username)
            LEFT JOIN likes l ON p.id = l.post_id
            LEFT JOIN profiles pr ON pr.user_id = COALESCE(u.id, p.user_id)
            {where_sql}
            GROUP BY
                p.id,
                COALESCE(u.username, p.username),
                COALESCE(u.display_name, COALESCE(u.username, p.username)),
                u.handle,
                p.maker, p.region, p.car,
                p.comment, p.image, p.created_at, pr.icon
            {order_sql}
            {limit_sql}
        """, params)
        rows = cur.fetchall()
    finally:
        cur.close()

    post_ids = [r[0] for r in rows]
    comments_map = fetch_comments_for_posts(db, post_ids, me_user_id)

    posts = []
    for r in rows:
        pid = r[0]
        post_comments = comments_map.get(pid, [])

        # index:
        # 0:id 1:username 2:display_name 3:handle 4:maker 5:region 6:car 7:comment 8:image 9:created_at 10:likes 11:icon
        posts.append({
            "id": pid,
            "username": r[1],
            "display_name": r[2],
            "handle": r[3],
            "maker": r[4],
            "region": r[5],
            "car": r[6],
            "comment": r[7],
            "image": r[8],
            "created_at": fmt_jst(r[9]),
            "likes": r[10],
            "user_icon": r[11],
            "comments": post_comments,
            "comment_count": len(post_comments)
        })
    return posts
