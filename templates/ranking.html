<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ ranking_title }} | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css?v=1002">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ===== Ranking Tabs ===== -->
  <div class="ranking-tabs">
    <a href="/ranking?period=day"   class="ranking-tab {% if period=='day' %}active{% endif %}">æ—¥</a>
    <a href="/ranking?period=week"  class="ranking-tab {% if period=='week' %}active{% endif %}">é€±</a>
    <a href="/ranking?period=month" class="ranking-tab {% if period=='month' %}active{% endif %}">æœˆ</a>
  </div>

  <h2 class="ranking-heading">{{ ranking_title }}</h2>

  {% if posts %}
    {% for post in posts %}
    <article class="post ranking-post rank-{{ loop.index }}">

      <!-- ===== å…¨ä½“ã‚¯ãƒªãƒƒã‚¯ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== -->
      <a href="/post/{{ post.id }}" class="post-overlay" aria-label="æŠ•ç¨¿ã‚’è¦‹ã‚‹"></a>

      <!-- ===== Header ===== -->
      <div class="post-top">

        <div class="post-title">

          <!-- é †ä½ -->
          <span class="rank-badge rank-{{ loop.index }}">
            {{ loop.index }}
          </span>

          <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
          {% if post.user_icon %}
            <div class="avatar">
              <a href="/user/{{ post.profile_key | urlencode }}" onclick="event.stopPropagation();">
                <img src="{{ post.user_icon }}" alt="icon">
              </a>
            </div>
          {% else %}
            <a href="/user/{{ post.profile_key | urlencode }}" onclick="event.stopPropagation();">
              <span class="avatar-fallback"></span>
            </a>
          {% endif %}

          <!-- åå‰ï¼šè»Šå -->
          <a href="/user/{{ post.profile_key | urlencode }}"
             class="post-user"
             onclick="event.stopPropagation();">
            {{ post.display_name }}ï¼š{{ post.car }}
          </a>

        </div>

        <span class="post-date">{{ post.created_at }}</span>
      </div>

      <!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
      {% if post.comment %}
        <div class="post-text">{{ post.comment }}</div>
      {% endif %}

      <!-- ç”»åƒ -->
      {% if post.image %}
        <div class="post-image">
          <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ">
        </div>
      {% endif %}

      <!-- ===== Actionsï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰ ===== -->
      <div class="post-actions" onclick="event.stopPropagation();">

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
        <a href="/post/{{ post.id }}#comments"
           class="action-btn"
           onclick="event.stopPropagation();">
          ğŸ’¬ <span class="count">{{ post.comment_count }}</span>
        </a>

        <!-- ã„ã„ã­ -->
        {% if user %}
          <button type="button"
                  class="like-btn js-like {% if post.id in liked_posts %}liked{% endif %}"
                  data-post-id="{{ post.id }}">
            <span class="heart">
              {% if post.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </span>
            <span class="like-count">{{ post.likes }}</span>
          </button>
        {% else %}
          <span>ğŸ¤ {{ post.likes }}</span>
        {% endif %}

      </div>

    </article>
    {% endfor %}
  {% else %}
    <p style="color:#888; margin-top:24px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}

</main>

<!-- ===== Like JSï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ»å®Œå…¨å®‰å®šï¼‰ ===== -->
<script>
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".js-like");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const postId = btn.dataset.postId;

  const res = await fetch(`/api/like/${postId}`, {
    method: "POST",
    credentials: "same-origin"
  });

  if (!res.ok) {
    if (res.status === 401) location.href = "/login";
    return;
  }

  const data = await res.json();

  btn.classList.toggle("liked", data.liked);
  btn.querySelector(".heart").textContent = data.liked ? "â¤ï¸" : "ğŸ¤";
  btn.querySelector(".like-count").textContent = data.likes;
});
</script>

</body>
</html>
