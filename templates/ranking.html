<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ ranking_title }} | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css?v=999">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ======================
       Ranking Tabs
  ====================== -->
  <div class="ranking-tabs">
    <a href="/ranking?period=day"
       class="ranking-tab {% if period=='day' %}active{% endif %}">æ—¥</a>
    <a href="/ranking?period=week"
       class="ranking-tab {% if period=='week' %}active{% endif %}">é€±</a>
    <a href="/ranking?period=month"
       class="ranking-tab {% if period=='month' %}active{% endif %}">æœˆ</a>
  </div>

  <h2 class="ranking-heading">{{ ranking_title }}</h2>

  {% if posts %}
    {% for post in posts %}
      <article class="post post-card ranking-card rank-{{ loop.index }}"
               onclick="location.href='/post/{{ post.id }}';">

        <!-- ======================
             Headerï¼ˆé †ä½ + ã‚¢ã‚¤ã‚³ãƒ³ + åå‰ï¼šè»Šåï¼‰
        ====================== -->
        <div class="post-top ranking-header"
             onclick="event.stopPropagation();">

          <!-- é †ä½ -->
          <div class="rank-badge">{{ loop.index }}</div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
          <div class="post-title">

            {% if post.user_icon %}
              <a href="/user/{{ post.profile_key | urlencode }}"
                 class="avatar"
                 onclick="event.stopPropagation();">
                <img src="{{ post.user_icon }}" alt="icon">
              </a>
            {% else %}
              <a href="/user/{{ post.profile_key | urlencode }}"
                 onclick="event.stopPropagation();">
                <span class="avatar-fallback"></span>
              </a>
            {% endif %}

            <div class="ranking-name">
              <a href="/user/{{ post.profile_key | urlencode }}"
                 class="post-user"
                 onclick="event.stopPropagation();">
                {{ post.display_name }}
              </a>
              <span>ï¼š</span>
              <span class="ranking-car">{{ post.car }}</span>
            </div>

          </div>
        </div>

        <!-- ======================
             Imageï¼ˆå¿…ãšä¸‹ï¼‰
        ====================== -->
        {% if post.image %}
          <div class="post-image">
            <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ">
          </div>
        {% endif %}

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚ã‚Œã°ï¼‰ -->
        {% if post.comment %}
          <div class="post-text">{{ post.comment | trim }}</div>
        {% endif %}

        <!-- ======================
             Actionsï¼ˆå³å¯„ã›ï¼‰
        ====================== -->
        <div class="post-actions" onclick="event.stopPropagation();">

          <!-- å‰Šé™¤ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰ -->
          {% if me_user_id and post.user_id == me_user_id %}
            <form action="/delete/{{ post.id }}"
                  method="post"
                  class="inline-form">
              <button type="submit" class="delete-btn">ğŸ—‘</button>
            </form>
          {% endif %}

          <!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
          <a href="/post/{{ post.id }}#comments"
             class="action-btn">
            ğŸ’¬ <span class="count">{{ post.comment_count }}</span>
          </a>

          <!-- ã„ã„ã­ -->
          {% if user %}
            <button type="button"
                    class="like-btn js-like {% if post.id in liked_posts %}liked{% endif %}"
                    data-post-id="{{ post.id }}">
              <span class="heart heart-off">ğŸ¤</span>
              <span class="heart heart-on">â¤ï¸</span>
              <span class="like-count">{{ post.likes }}</span>
            </button>
          {% else %}
            <span>ğŸ¤ {{ post.likes }}</span>
          {% endif %}
        </div>

        <div class="ranking-meta">
          {{ post.created_at | trim }}
        </div>

      </article>
    {% endfor %}
  {% else %}
    <p style="color:#888; margin-top:24px;">
      ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“
    </p>
  {% endif %}

</main>

<!-- ======================
     Like JSï¼ˆrankingå°‚ç”¨ï¼‰
====================== -->
<script>
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".js-like");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const postId = btn.dataset.postId;

  const res = await fetch(`/api/like/${postId}`, {
    method: "POST",
    credentials: "same-origin"
  });

  if (!res.ok) {
    if (res.status === 401) {
      location.href = "/login";
    }
    return;
  }

  const data = await res.json();
  btn.classList.toggle("liked", data.liked);
  btn.querySelector(".like-count").textContent = data.likes;
});
</script>

</body>
</html>
