<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ ranking_title }} | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css?v=FINAL">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ===== Ranking Tabs ===== -->
  <div class="ranking-tabs">
    <a href="/ranking?period=day"   class="ranking-tab {% if period=='day' %}active{% endif %}">æ—¥</a>
    <a href="/ranking?period=week"  class="ranking-tab {% if period=='week' %}active{% endif %}">é€±</a>
    <a href="/ranking?period=month" class="ranking-tab {% if period=='month' %}active{% endif %}">æœˆ</a>
  </div>

  <h2 class="ranking-heading">{{ ranking_title }}</h2>

  {% if posts %}
    {% for post in posts %}
    <article class="post ranking-post rank-{{ loop.index }}">

      <!-- ===== Headerï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é·ç§»ã®ã¿ï¼‰ ===== -->
      <div class="post-top">
        <div class="post-title">

          <!-- Rank -->
          <span class="rank-badge rank-{{ loop.index }}">{{ loop.index }}</span>

          <!-- Avatar -->
          <a href="/user/{{ post.profile_key | urlencode }}" class="avatar">
            {% if post.user_icon %}
              <img src="{{ post.user_icon }}" alt="icon">
            {% else %}
              <span class="avatar-fallback"></span>
            {% endif %}
          </a>

          <!-- Name : Car -->
          <span class="post-user">
            {{ post.display_name }}ï¼š{{ post.car }}
          </span>

        </div>

        <span class="post-date">{{ post.created_at }}</span>
      </div>

      <!-- ===== æŠ•ç¨¿æœ¬æ–‡ï¼‹ç”»åƒï¼ˆè©³ç´°é·ç§»å°‚ç”¨ï¼‰ ===== -->
      <a href="/post/{{ post.id }}" class="post-body-link">

        {% if post.comment %}
          <div class="post-text">{{ post.comment }}</div>
        {% endif %}

        {% if post.image %}
          <div class="post-image">
            <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ">
          </div>
        {% endif %}

      </a>

      <!-- ===== Actionsï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰ ===== -->
      <div class="post-actions">

        <!-- Comment -->
        <a href="/post/{{ post.id }}#comments" class="action-btn">
          ğŸ’¬ <span class="count">{{ post.comment_count }}</span>
        </a>

        <!-- Like -->
        {% if user %}
          <button type="button"
                  class="like-btn js-like {% if post.id in liked_posts %}liked{% endif %}"
                  data-post-id="{{ post.id }}"
                  aria-pressed="{% if post.id in liked_posts %}true{% else %}false{% endif %}">
            <span class="heart">
              {% if post.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </span>
            <span class="like-count">{{ post.likes }}</span>
          </button>
        {% else %}
          <span>ğŸ¤ {{ post.likes }}</span>
        {% endif %}

      </div>

    </article>
    {% endfor %}
  {% else %}
    <p style="color:#888; margin-top:24px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}

</main>

<!-- ===== Like JSï¼ˆæœ€å°ãƒ»ç«¶åˆã‚¼ãƒ­ï¼‰ ===== -->
<script>
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".js-like");
  if (!btn) return;

  if (btn.disabled) return;
  btn.disabled = true;

  const postId = btn.dataset.postId;

  try {
    const res = await fetch(`/api/like/${postId}`, {
      method: "POST",
      credentials: "same-origin"
    });

    if (!res.ok) {
      if (res.status === 401) location.href = "/login";
      return;
    }

    const data = await res.json();

    btn.classList.toggle("liked", data.liked);
    btn.setAttribute("aria-pressed", data.liked ? "true" : "false");
    btn.querySelector(".heart").textContent = data.liked ? "â¤ï¸" : "ğŸ¤";
    btn.querySelector(".like-count").textContent = data.likes;

  } finally {
    btn.disabled = false;
  }
});
</script>

</body>
</html>
