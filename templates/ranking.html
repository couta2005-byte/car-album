# ======================
# ranking（安定版）
# ======================
@app.get("/ranking", response_class=HTMLResponse)
def ranking(
    request: Request,
    period: str = Query(default="day"),
    user: str = Cookie(default=None)
):
    me = unquote(user) if user else None
    now_utc = datetime.utcnow()

    if period == "week":
        since = now_utc - timedelta(days=7)
        title = "週間ランキング TOP10"
    elif period == "month":
        since = now_utc - timedelta(days=30)
        title = "月間ランキング TOP10"
    else:
        # ★ 日間は「直近24時間」に変更（ここが肝）
        since = now_utc - timedelta(hours=24)
        title = "日間ランキング TOP10"

    db = get_db()
    try:
        posts = fetch_posts(
            db,
            "WHERE p.created_at >= %s",
            (since,),
            order_sql="ORDER BY like_count DESC, p.id DESC",
            limit_sql="LIMIT 10"
        )
        liked_posts = get_liked_posts(db, me)
    finally:
        db.close()

    return templates.TemplateResponse("ranking.html", {
        "request": request,
        "posts": posts,
        "user": me,
        "liked_posts": liked_posts,
        "mode": f"ranking_{period}",
        "ranking_title": title,
        "period": period
    })
