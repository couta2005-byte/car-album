<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ¤œç´¢ | Car Album</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <h2 style="margin:12px 0 6px;">æ¤œç´¢</h2>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ¢ã™å°‚ç”¨ï¼‰ -->
  <form action="/search" method="get" class="search-box">
    <input
      type="text"
      name="q"
      value="{{ q }}"
      placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»è»Šåãƒ»åœ°åŸŸãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã§æ¤œç´¢"
    />
    <button type="submit">æ¤œç´¢</button>
  </form>

  {% if q %}
    <div class="search-context">
      ã€Œ<strong>{{ q }}</strong>ã€ã®æ¤œç´¢çµæœ
    </div>

    <!-- ===== ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ===== -->
    <div class="search-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>

    {% if users and users|length > 0 %}
      <div class="search-chips">
        {% for u in users %}
          <a href="/user/{{ u | urlencode }}" class="chip">
            @{{ u }}
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="search-empty">è©²å½“ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—</div>
    {% endif %}

    <!-- ===== æŠ•ç¨¿ ===== -->
    <div class="search-title">
      æŠ•ç¨¿ï¼ˆ{{ posts|length }}ä»¶ï¼‰
    </div>

    {% if posts and posts|length > 0 %}
      {% for p in posts %}
        <article class="post"
                 role="link"
                 tabindex="0"
                 onclick="location.href='/post/{{ p.id }}';"
                 onkeydown="if(event.key==='Enter' || event.key===' '){ location.href='/post/{{ p.id }}'; }">

          <div class="post-top">
            <div>
              <div class="post-car">
                {{ p.car or "" }}
                {% if p.maker %}<span>/ {{ p.maker }}</span>{% endif %}
                {% if p.region %}<span>/ {{ p.region }}</span>{% endif %}
              </div>

              <div class="post-sub">
                <a href="/user/{{ p.username | urlencode }}"
                   onclick="event.stopPropagation();">
                  @{{ p.username }}
                </a>
                <span>ãƒ»</span>

                {% if user %}
                  <!-- âœ… ãƒªãƒ­ãƒ¼ãƒ‰ç„¡ã—ã„ã„ã­ï¼ˆæ¤œç´¢çµæœï¼‰ -->
                  <button type="button"
                          class="like-btn js-like {% if p.id in liked_posts %}active{% endif %}"
                          data-post-id="{{ p.id }}"
                          data-liked="{% if p.id in liked_posts %}1{% else %}0{% endif %}"
                          onclick="event.stopPropagation();">
                    <span class="like-icon">{% if p.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                    <span class="like-count">{{ p.likes }}</span>
                  </button>
                {% else %}
                  <span>ğŸ¤ {{ p.likes }}</span>
                {% endif %}
              </div>
            </div>

            <div class="post-date">
              {{ p.created_at }}
            </div>
          </div>

          {% if p.comment %}
            <div class="post-comment">
              {{ p.comment }}
            </div>
          {% endif %}

          {% if p.image %}
            <div class="post-image">
              <img src="{{ p.image }}" alt="post image" />
            </div>
          {% endif %}

        </article>
      {% endfor %}
    {% else %}
      <div class="search-empty">
        è©²å½“ã™ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“
      </div>
    {% endif %}

  {% else %}
    <div class="search-guide">
      ä¸Šã®å…¥åŠ›æ¬„ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦æ¤œç´¢ã—ã¦ã­ã€‚
    </div>
  {% endif %}

</main>

<script>
  // âœ… æ¤œç´¢ï¼šã„ã„ã­å³åæ˜ ï¼ˆ/api/like/{post_id}ï¼‰
  // â€»è¨˜äº‹ã‚¯ãƒªãƒƒã‚¯é·ç§»ã‚ˆã‚Šå…ˆã«æ­¢ã‚ã‚‹ãŸã‚ capture=true
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-like");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const postId = btn.dataset.postId;
    if (!postId) return;

    if (btn.dataset.loading === "1") return;
    btn.dataset.loading = "1";

    try {
      const res = await fetch(`/api/like/${postId}`, {
        method: "POST",
        credentials: "same-origin"
      });

      if (res.status === 401) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­");
        return;
      }
      if (!res.ok) {
        alert("ã„ã„ã­å¤±æ•—ï¼ˆAPIã‚¨ãƒ©ãƒ¼ï¼‰");
        return;
      }

      const data = await res.json();
      if (!data.ok) {
        alert(data.error || "ã„ã„ã­å¤±æ•—");
        return;
      }

      // æ•°å­—æ›´æ–°
      const countEl = btn.querySelector(".like-count");
      if (countEl) countEl.textContent = String(data.likes);

      // çŠ¶æ…‹æ›´æ–°
      btn.dataset.liked = data.liked ? "1" : "0";
      btn.classList.toggle("active", !!data.liked);

      // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
      const iconEl = btn.querySelector(".like-icon");
      if (iconEl) iconEl.textContent = data.liked ? "â¤ï¸" : "ğŸ¤";

    } catch (err) {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    } finally {
      btn.dataset.loading = "0";
    }
  }, true);
</script>

</body>
</html>
