<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ ranking_title }} | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css?v=FINAL">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ===== Ranking Tabs ===== -->
  <div class="ranking-tabs">
    <a href="/ranking?period=day"   class="ranking-tab {% if period=='day' %}active{% endif %}">æ—¥</a>
    <a href="/ranking?period=week"  class="ranking-tab {% if period=='week' %}active{% endif %}">é€±</a>
    <a href="/ranking?period=month" class="ranking-tab {% if period=='month' %}active{% endif %}">æœˆ</a>
  </div>

  <h2 class="ranking-heading">{{ ranking_title }}</h2>

  {% if posts %}
    {% for post in posts %}
    <article class="post ranking-post rank-{{ loop.index }}"
             data-href="/post/{{ post.id }}">

      <!-- ===== Header ===== -->
      <div class="post-top">

        <div class="post-title">

          <!-- Rank -->
          <span class="rank-badge rank-{{ loop.index }}">{{ loop.index }}</span>

          <!-- Avatar -->
          {% if post.user_icon %}
            <a href="/user/{{ post.profile_key | urlencode }}" class="avatar">
              <img src="{{ post.user_icon }}" alt="icon">
            </a>
          {% else %}
            <a href="/user/{{ post.profile_key | urlencode }}">
              <span class="avatar-fallback"></span>
            </a>
          {% endif %}

          <!-- Name : Car -->
          <span class="post-user">
            {{ post.display_name }}ï¼š{{ post.car }}
          </span>

        </div>

        <span class="post-date">{{ post.created_at }}</span>
      </div>

      {% if post.comment %}
        <div class="post-text">{{ post.comment }}</div>
      {% endif %}

      {% if post.image %}
        <div class="post-image">
          <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ">
        </div>
      {% endif %}

      <!-- ===== Actions ===== -->
      <div class="post-actions">

        <!-- Comment -->
        <a href="/post/{{ post.id }}#comments" class="action-btn">
          ğŸ’¬ <span class="count">{{ post.comment_count }}</span>
        </a>

        <!-- Like -->
        {% if user %}
          <button type="button"
                  class="like-btn js-like {% if post.id in liked_posts %}liked{% endif %}"
                  data-post-id="{{ post.id }}"
                  data-liked="{% if post.id in liked_posts %}1{% else %}0{% endif %}">
            <span class="heart">
              {% if post.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </span>
            <span class="like-count">{{ post.likes }}</span>
          </button>
        {% else %}
          <span>ğŸ¤ {{ post.likes }}</span>
        {% endif %}

      </div>

    </article>
    {% endfor %}
  {% else %}
    <p style="color:#888; margin-top:24px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}

</main>

<!-- ===== JSï¼ˆå®Œå…¨å®‰å®šï¼‰ ===== -->
<script>
/* ========= æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰é·ç§» ========= */
document.querySelectorAll(".ranking-post").forEach(card => {
  card.addEventListener("click", (e) => {
    if (e.target.closest("a, button")) return;
    location.href = card.dataset.href;
  });
});

/* ========= ã„ã„ã­ï¼ˆå³æ™‚UI + ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ========= */
document.querySelectorAll(".js-like").forEach(btn => {
  btn.addEventListener("click", async (e) => {
    e.stopPropagation();

    if (btn.disabled) return;
    btn.disabled = true;

    const postId = btn.dataset.postId;
    const likedBefore = btn.dataset.liked === "1";
    const countEl = btn.querySelector(".like-count");
    const heartEl = btn.querySelector(".heart");

    /* æ¥½è¦³çš„UI */
    btn.dataset.liked = likedBefore ? "0" : "1";
    btn.classList.toggle("liked", !likedBefore);
    heartEl.textContent = likedBefore ? "ğŸ¤" : "â¤ï¸";
    countEl.textContent = Number(countEl.textContent) + (likedBefore ? -1 : 1);

    try {
      const res = await fetch(`/api/like/${postId}`, {
        method: "POST",
        credentials: "same-origin"
      });

      if (!res.ok) throw new Error();

      const data = await res.json();

      btn.dataset.liked = data.liked ? "1" : "0";
      btn.classList.toggle("liked", data.liked);
      heartEl.textContent = data.liked ? "â¤ï¸" : "ğŸ¤";
      countEl.textContent = data.likes;

    } catch {
      /* ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
      btn.dataset.liked = likedBefore ? "1" : "0";
      btn.classList.toggle("liked", likedBefore);
      heartEl.textContent = likedBefore ? "â¤ï¸" : "ğŸ¤";
      countEl.textContent = Number(countEl.textContent) + (likedBefore ? 1 : -1);
      alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      btn.disabled = false;
    }
  });
});
</script>

</body>
</html>
