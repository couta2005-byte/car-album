<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ¤œç´¢ | Carbum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css?v=13">
</head>
<body>

{% include "_nav.html" %}

<main class="container">

  <!-- ===== Search Header ===== -->
  <section class="search-hero">
    <h1 class="search-title">æ¤œç´¢</h1>

    <!-- ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆè¿½åŠ ï¼‰ ===== -->
    <form action="/search" method="get" class="search-user-form">
      <input
        class="search-input"
        type="text"
        name="user_q"
        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆ@handle / è¡¨ç¤ºå / usernameï¼‰"
        value="{{ user_q }}"
      >
      <button class="search-btn" type="submit">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</button>
    </form>

    {% if user_q %}
      <p class="search-meta">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼š<span class="tag">{{ user_q }}</span>
      </p>
    {% endif %}

    {% if users %}
      <section class="search-section">
        <h2 class="section-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼</h2>
        <div class="user-list">
          {% for u in users %}
            <a class="user-pill" href="/user/{{ u.profile_key | urlencode }}">
              {% if u.icon %}
                <img src="{{ u.icon }}" class="avatar" alt="icon">
              {% else %}
                <span class="avatar-fallback"></span>
              {% endif %}
              <div class="user-pill-text">
                <div class="user-name">{{ u.display_name }}</div>
                <div class="user-handle">
                  @{{ u.handle if u.handle else u.username }}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    {% elif user_q %}
      <p class="empty-note">è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—</p>
    {% endif %}

    <!-- ===== æ—¢å­˜ï¼šæŠ•ç¨¿çµã‚Šè¾¼ã¿ ===== -->
    <form action="/search" method="get" class="search-advanced-form">
      <div class="search-grid">
        <input class="search-input" type="text" name="maker" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆä¾‹ï¼šãƒˆãƒ¨ã‚¿ï¼‰" value="{{ maker }}">
        <input class="search-input" type="text" name="car" placeholder="è»Šåï¼ˆä¾‹ï¼šãƒãƒ¼ã‚¯Xï¼‰" value="{{ car }}">
        <input class="search-input" type="text" name="region" placeholder="åœ°åŸŸï¼ˆä¾‹ï¼šæ—­å·ï¼‰" value="{{ region }}">
      </div>
      <button class="search-btn" type="submit">çµã‚Šè¾¼ã‚€</button>
    </form>

    {% if maker or car or region %}
      <p class="search-meta">
        çµã‚Šè¾¼ã¿ä¸­ï¼š
        {% if maker %}<span class="tag">ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼š{{ maker }}</span>{% endif %}
        {% if car %}<span class="tag">è»Šåï¼š{{ car }}</span>{% endif %}
        {% if region %}<span class="tag">åœ°åŸŸï¼š{{ region }}</span>{% endif %}
      </p>
    {% else %}
      <p class="search-meta">ãƒ¡ãƒ¼ã‚«ãƒ¼ / è»Šå / åœ°åŸŸ ã‚’å…¥ã‚Œã¦çµã‚Šè¾¼ã‚“ã§ã­</p>
    {% endif %}
  </section>

  <!-- ===== Posts ===== -->
  <section class="search-section">
    <h2 class="section-title">æŠ•ç¨¿{% if posts %}ï¼ˆ{{ posts|length }}ä»¶ï¼‰{% endif %}</h2>

    {% if maker or car or region %}
      {% if posts and posts|length > 0 %}
        <div class="posts">
        {% for post in posts %}
          <article class="post"
                   role="link"
                   tabindex="0"
                   onclick="location.href='/post/{{ post.id }}';"
                   onkeydown="if(event.key==='Enter' || event.key===' '){ location.href='/post/{{ post.id }}'; }"
                   style="position:relative;">

            <div class="post-top">
              <div class="post-title">

                {% if post.user_icon %}
                  <div class="avatar" onclick="event.stopPropagation();" style="position:relative; z-index:2;">
                    <a href="/user/{{ post.profile_key | urlencode }}" onclick="event.stopPropagation();">
                      <img src="{{ post.user_icon }}" alt="icon">
                    </a>
                  </div>
                {% else %}
                  <a href="/user/{{ post.profile_key | urlencode }}"
                     onclick="event.stopPropagation();"
                     style="position:relative; z-index:2; display:inline-block;">
                    <span class="avatar-fallback"></span>
                  </a>
                {% endif %}

                <div class="post-title-main">
                  <a href="/user/{{ post.profile_key | urlencode }}"
                     class="post-user"
                     style="position:relative; z-index:2; display:inline-flex; flex-direction:column; gap:2px;"
                     onclick="event.stopPropagation();">

                    <span style="font-weight:900;">
                      {{ post.display_name if post.display_name else post.username }}
                    </span>

                    <span style="color:#536471; font-size:12px; line-height:1;">
                      @{{ post.handle if post.handle else post.username }}
                    </span>
                  </a>

                  <span class="post-sep" style="margin:0 6px;">ï¼š</span>
                  <span class="post-car">{{ post.car }}</span>
                </div>
              </div>

              <span class="post-date">{{ post.created_at }}</span>
            </div>

            {% if post.comment %}
              <div class="post-comment">{{ post.comment }}</div>
            {% endif %}

            {% if post.image %}
              <div class="post-image">
                <img src="{{ post.image }}" alt="æŠ•ç¨¿ç”»åƒ">
              </div>
            {% endif %}

            <div class="post-actions" style="position:relative; z-index:2;" onclick="event.stopPropagation();">
              <div class="post-actions-right">

                {% if user and user == post.username %}
                  <form action="/delete/{{ post.id }}" method="post" onsubmit="event.stopPropagation();">
                    <button class="delete-btn" type="submit" onclick="event.stopPropagation();">ğŸ—‘ å‰Šé™¤</button>
                  </form>
                {% endif %}

                <a href="/post/{{ post.id }}#comments"
                   class="action-btn"
                   onclick="event.stopPropagation();">
                  <span>ğŸ’¬</span>
                  <span class="count">{{ post.comment_count }}</span>
                </a>

                {% if user %}
                  <button type="button"
                          class="like-btn js-like {% if post.id in liked_posts %}active{% endif %}"
                          data-post-id="{{ post.id }}"
                          data-liked="{% if post.id in liked_posts %}1{% else %}0{% endif %}"
                          aria-pressed="{% if post.id in liked_posts %}true{% else %}false{% endif %}">
                    <span class="like-icon">{% if post.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                    <span class="like-count">{{ post.likes }}</span>
                  </button>
                {% else %}
                  <span>ğŸ¤ {{ post.likes }}</span>
                {% endif %}

              </div>
            </div>

          </article>
        {% endfor %}
        </div>
      {% else %}
        <p class="empty-note">è©²å½“æŠ•ç¨¿ãªã—</p>
      {% endif %}
    {% else %}
      <p class="empty-note">ä¸Šã®å…¥åŠ›æ¬„ã§çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’å…¥ã‚Œã¦ã­</p>
    {% endif %}
  </section>

</main>

</body>
</html>

<script>
(function(){
  async function postJson(url){
    const res = await fetch(url, {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json().catch(()=>null);
    return { ok: res.ok, status: res.status, data };
  }

  function setBtn(btn, liked, likes){
    btn.dataset.liked = liked ? "1" : "0";
    btn.classList.toggle("active", liked);
    btn.setAttribute("aria-pressed", liked ? "true" : "false");
    const icon = btn.querySelector(".like-icon");
    const count = btn.querySelector(".like-count");
    if (icon) icon.textContent = liked ? "â¤ï¸" : "ğŸ¤";
    if (count) count.textContent = String(likes);
  }

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-like");
    if(!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const postId = btn.dataset.postId;
    if(!postId) return;

    if (btn.classList.contains("is-loading")) return;
    btn.classList.add("is-loading");
    btn.disabled = true;

    try{
      const r = await postJson(`/api/like/${postId}`);
      if(!r.ok || !r.data || r.data.ok !== true){
        if(r.status === 401) { location.href = "/login"; return; }
        alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }
      setBtn(btn, !!r.data.liked, r.data.likes);
    } finally {
      btn.disabled = false;
      btn.classList.remove("is-loading");
    }
  }, { capture: true, passive: false });
})();
</script>
